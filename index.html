<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISPAN SE Capacity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); padding: 1.5rem; margin-bottom: 1.5rem; }
        .data-table-container { max-height: 400px; overflow-y: auto; }
        .delete-btn { background-color: #f87171; color: white; border: none; padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.2s; }
        .delete-btn:hover { background-color: #ef4444; }
        .reset-btn { background-color: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer; transition: background-color 0.2s; }
        .reset-btn:hover { background-color: #4b5563; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4F46E5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .tab-button.active { background-color: #4F46E5; color: white; }
        .tab-button:not(.active) { background-color: #e5e7eb; color: #6b7280; }
        .tab-button:not(.active):hover { background-color: #d1d5db; }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="text-center">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-gray-700 font-medium">Loading data...</p>
    </div>
</div>

<div class="container mx-auto p-4 md:p-8">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h1 class="text-4xl font-bold text-gray-900">SE Capacity & Pipeline Dashboard</h1>
        <button onclick="resetToDefaults()" class="reset-btn">Reset to Default Data</button>
    </div>

    <!-- Configuration Notice -->
    <div id="configNotice" class="card bg-yellow-50 border-2 border-yellow-400">
        <h2 class="text-lg font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Configuration Required</h2>
        <p class="text-sm text-yellow-700 mb-3">
            Please add your Supabase URL and API key in the code (lines 199-200).
            <a href="#" onclick="alert('Setup Instructions:\\n\\n1. Go to supabase.com and create a project\\n2. Create the assignments table using the SQL in the instructions\\n3. Get your Project URL and anon key from Project Settings > API\\n4. Replace SUPABASE_URL and SUPABASE_KEY in the code'); return false;" class="underline font-medium">View setup instructions</a>
        </p>
    </div>

    <!-- Shared Data Notice -->
    <div class="card bg-blue-50 border border-blue-200">
        <p class="text-sm text-blue-800">
            <strong>üìä Shared Dashboard:</strong> All data is stored in Supabase and synced in real-time across all team members. 
            Changes appear instantly for everyone!
        </p>
    </div>

    <!-- 1. ADD NEW ASSIGNMENT FORM -->
    <div class="card">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Add New Assignment</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div>
                <label for="opportunityType" class="block text-sm font-medium text-gray-700">Type</label>
                <select id="opportunityType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white">
                    <option value="Bank">Bank</option>
                    <option value="ERP">ERP</option>
                </select>
            </div>
            <div>
                <label for="opportunityName" class="block text-sm font-medium text-gray-700">Name</label>
                <input type="text" id="opportunityName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Enter bank or ERP name">
            </div>
            <div>
                <label for="seName" class="block text-sm font-medium text-gray-700">Solution Engineer</label>
                <select id="seName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white">
                    <option value="Rudra">Rudra</option>
                    <option value="David">David</option>
                    <option value="Liam">Liam</option>
                </select>
            </div>
            <div>
                <label for="funnelStage" class="block text-sm font-medium text-gray-700">Funnel Stage</label>
                <select id="funnelStage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white">
                    <option value="Top of Funnel">Top of Funnel</option>
                    <option value="Middle of Funnel">Middle of Funnel</option>
                    <option value="Bottom of Funnel">Bottom of Funnel</option>
                </select>
            </div>
            <button onclick="addAssignment()" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                Add Assignment
            </button>
        </div>
    </div>

    <!-- 2. INTERACTIVE CHARTS -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-700">Analytics Dashboard</h2>
            <div class="flex gap-2">
                <button class="tab-button active" onclick="switchView('banks')" id="banksViewBtn">Banks</button>
                <button class="tab-button" onclick="switchView('erps')" id="erpsViewBtn">ERPs</button>
                <button class="tab-button" onclick="switchView('combined')" id="combinedViewBtn">Combined</button>
            </div>
        </div>

        <!-- Banks View -->
        <div id="banksView" class="view-container">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Chart 1: SE Capacity for Banks -->
                <div class="lg:col-span-1 flex flex-col justify-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">SE Capacity (Banks)</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="bankCapacityChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Bank Funnel Distribution -->
                <div class="lg:col-span-2">
                    <h3 id="bankFunnelTitle" class="text-lg font-semibold text-gray-700 mb-4">Bank Funnel Distribution</h3>
                    <div class="mb-4 flex items-center space-x-3">
                        <label for="bankSeFilter" class="text-sm font-medium text-gray-700">Filter By SE:</label>
                        <select id="bankSeFilter" class="rounded-md border-gray-300 shadow-sm p-2 border bg-white" onchange="refreshDashboard()">
                            <option value="All">All SEs</option>
                            <option value="Rudra">Rudra</option>
                            <option value="David">David</option>
                            <option value="Liam">Liam</option>
                        </select>
                    </div>
                    <div class="h-80">
                        <canvas id="bankFunnelChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ERPs View -->
        <div id="erpsView" class="view-container" style="display: none;">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Chart 3: SE Capacity for ERPs -->
                <div class="lg:col-span-1 flex flex-col justify-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">SE Capacity (ERPs)</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="erpCapacityChart"></canvas>
                    </div>
                </div>

                <!-- Chart 4: ERP Funnel Distribution -->
                <div class="lg:col-span-2">
                    <h3 id="erpFunnelTitle" class="text-lg font-semibold text-gray-700 mb-4">ERP Funnel Distribution</h3>
                    <div class="mb-4 flex items-center space-x-3">
                        <label for="erpSeFilter" class="text-sm font-medium text-gray-700">Filter By SE:</label>
                        <select id="erpSeFilter" class="rounded-md border-gray-300 shadow-sm p-2 border bg-white" onchange="refreshDashboard()">
                            <option value="All">All SEs</option>
                            <option value="Rudra">Rudra</option>
                            <option value="David">David</option>
                            <option value="Liam">Liam</option>
                        </select>
                    </div>
                    <div class="h-80">
                        <canvas id="erpFunnelChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined View -->
        <div id="combinedView" class="view-container" style="display: none;">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Chart 5: Total SE Capacity (Banks + ERPs) -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Total SE Capacity (All Assignments)</h3>
                    <div class="h-64">
                        <canvas id="totalCapacityChart"></canvas>
                    </div>
                </div>

                <!-- Chart 6: Banks vs ERPs Distribution -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Banks vs ERPs Distribution</h3>
                    <div class="h-64">
                        <canvas id="typeDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chart 7: SE Breakdown by Type -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">SE Assignments by Type</h3>
                    <div class="h-80">
                        <canvas id="seTypeChart"></canvas>
                    </div>
                </div>

                <!-- Chart 8: Funnel Stage Comparison -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Funnel Stages (Banks vs ERPs)</h3>
                    <div class="h-80">
                        <canvas id="stageCombinedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. RAW DATA TABLE -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-700">All Assignments</h2>
            <div class="flex gap-2">
                <label class="text-sm font-medium text-gray-700 self-center">Filter:</label>
                <select id="tableTypeFilter" class="rounded-md border-gray-300 shadow-sm p-2 border bg-white text-sm" onchange="renderTable()">
                    <option value="All">All Types</option>
                    <option value="Bank">Banks Only</option>
                    <option value="ERP">ERPs Only</option>
                </select>
            </div>
        </div>
        <div class="data-table-container">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('type')">
                            Type <span id="sort-type">‚ÜïÔ∏è</span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('opportunity_name')">
                            Name <span id="sort-opportunity_name">‚ÜïÔ∏è</span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('se')">
                            Solution Engineer <span id="sort-se">‚ÜïÔ∏è</span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('stage')">
                            Funnel Stage <span id="sort-stage">‚ÜïÔ∏è</span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be populated here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // ========================================
    // CONFIGURATION - ADD YOUR SUPABASE CREDENTIALS HERE
    // ========================================
    const SUPABASE_URL = 'https://wrxkjecleusrfkvrcsdh.supabase.co';  // e.g., 'https://xxxxx.supabase.co'
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyeGtqZWNsZXVzcmZrdnJjc2RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1Mzc5MjgsImV4cCI6MjA3ODExMzkyOH0.0XG2tR0U8nVMcpRc_r7uG2kmeX38l2Adwgv_5rOQG4w';  // Your anon/public key
    // ========================================

    // Initialize Supabase client
    let supabaseClient;
    let isConfigured = false;

    if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && SUPABASE_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE') {
        const { createClient } = supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        isConfigured = true;
        document.getElementById('configNotice').style.display = 'none';
    }

    // --- DEFAULT DATA ---
    const defaultAssignments = [
        { opportunity_name: "First National Bank", se: "Rudra", type: "Bank", stage: "Middle of Funnel" },
        { opportunity_name: "Apex Global Credit", se: "Rudra", type: "Bank", stage: "Top of Funnel" },
        { opportunity_name: "SAP Implementation", se: "Rudra", type: "ERP", stage: "Middle of Funnel" },
        { opportunity_name: "Pacific Coast Trust", se: "David", type: "Bank", stage: "Bottom of Funnel" },
        { opportunity_name: "Oracle Migration", se: "David", type: "ERP", stage: "Top of Funnel" },
        { opportunity_name: "Millennium Bank", se: "David", type: "Bank", stage: "Top of Funnel" },
        { opportunity_name: "Aurora Savings Co.", se: "Liam", type: "Bank", stage: "Middle of Funnel" },
        { opportunity_name: "NetSuite Integration", se: "Liam", type: "ERP", stage: "Bottom of Funnel" },
        { opportunity_name: "Global Tech Bank", se: "Liam", type: "Bank", stage: "Bottom of Funnel" },
    ];

    let assignments = [];
    const funnelStages = ["Top of Funnel", "Middle of Funnel", "Bottom of Funnel"];
    const seNames = ["Rudra", "David", "Liam"];
    const stageColors = {
        "Top of Funnel": '#4F46E5',
        "Middle of Funnel": '#10B981',
        "Bottom of Funnel": '#F59E0B',
    };

    let chartInstances = {};
    let currentView = 'banks';
    let sortColumn = null;
    let sortDirection = 'asc';

    // --- UTILITY FUNCTIONS ---
    
    function showLoading(show = true) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showError(message) {
        alert('Error: ' + message);
    }

    function switchView(view) {
        currentView = view;
        
        document.getElementById('banksViewBtn').classList.toggle('active', view === 'banks');
        document.getElementById('erpsViewBtn').classList.toggle('active', view === 'erps');
        document.getElementById('combinedViewBtn').classList.toggle('active', view === 'combined');
        
        document.getElementById('banksView').style.display = view === 'banks' ? 'block' : 'none';
        document.getElementById('erpsView').style.display = view === 'erps' ? 'block' : 'none';
        document.getElementById('combinedView').style.display = view === 'combined' ? 'block' : 'none';
        
        refreshDashboard();
    }

    // Load data from Supabase
    async function loadData() {
        if (!isConfigured) {
            console.warn('Supabase not configured. Using default data.');
            assignments = [...defaultAssignments];
            refreshDashboard();
            return;
        }

        showLoading(true);
        try {
            const { data, error } = await supabaseClient
                .from('assignments')
                .select('*')
                .order('id', { ascending: true });

            if (error) throw error;

            if (data && data.length > 0) {
                assignments = data;
            } else {
                console.log('No data in database, using defaults');
                assignments = [...defaultAssignments];
            }
        } catch (error) {
            console.error('Error loading data:', error);
            showError('Failed to load data from Supabase: ' + error.message);
            assignments = [...defaultAssignments];
        } finally {
            showLoading(false);
            refreshDashboard();
        }
    }

    // Add new assignment
    async function addAssignment() {
        const name = document.getElementById('opportunityName').value.trim();
        const type = document.getElementById('opportunityType').value;
        const se = document.getElementById('seName').value;
        const stage = document.getElementById('funnelStage').value;

        if (!name) {
            alert('Please enter a name');
            return;
        }

        if (!isConfigured) {
            alert('Supabase not configured. Please add your credentials.');
            return;
        }

        showLoading(true);
        try {
            const { data, error } = await supabaseClient
                .from('assignments')
                .insert([{ opportunity_name: name, type: type, se: se, stage: stage }])
                .select();

            if (error) throw error;

            document.getElementById('opportunityName').value = '';
            await loadData();
        } catch (error) {
            console.error('Error adding assignment:', error);
            showError('Failed to add assignment: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Delete assignment
    async function deleteAssignment(id) {
        if (!isConfigured) {
            alert('Supabase not configured.');
            return;
        }

        if (!confirm('Are you sure you want to delete this assignment?')) {
            return;
        }

        showLoading(true);
        try {
            const { error } = await supabaseClient
                .from('assignments')
                .delete()
                .eq('id', id);

            if (error) throw error;

            await loadData();
        } catch (error) {
            console.error('Error deleting assignment:', error);
            showError('Failed to delete assignment: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Update assignment field
    async function updateAssignment(id, field, value) {
        if (!isConfigured) {
            alert('Supabase not configured.');
            return false;
        }

        showLoading(true);
        try {
            const updateData = {};
            updateData[field] = value;

            const { error } = await supabaseClient
                .from('assignments')
                .update(updateData)
                .eq('id', id);

            if (error) throw error;

            // Update local data
            const assignment = assignments.find(a => a.id === id);
            if (assignment) {
                assignment[field] = value;
            }

            showLoading(false);
            refreshDashboard();
            return true;
        } catch (error) {
            console.error('Error updating assignment:', error);
            showError('Failed to update assignment: ' + error.message);
            showLoading(false);
            return false;
        }
    }

    // Sort table
    function sortTable(column) {
        // Toggle sort direction if clicking same column
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }

        // Update sort indicators
        ['type', 'opportunity_name', 'se', 'stage'].forEach(col => {
            const indicator = document.getElementById(`sort-${col}`);
            if (indicator) {
                if (col === column) {
                    indicator.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
                } else {
                    indicator.textContent = '‚ÜïÔ∏è';
                }
            }
        });

        // Sort assignments
        assignments.sort((a, b) => {
            let aVal = a[column] || '';
            let bVal = b[column] || '';

            // Convert to lowercase for case-insensitive sorting
            if (typeof aVal === 'string') aVal = aVal.toLowerCase();
            if (typeof bVal === 'string') bVal = bVal.toLowerCase();

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        renderTable();
    }
    async function resetToDefaults() {
        if (!isConfigured) {
            alert('Supabase not configured.');
            return;
        }

        if (!confirm('Reset all data to defaults? This affects all users and cannot be undone.')) {
            return;
        }

        showLoading(true);
        try {
            const { error: deleteError } = await supabaseClient
                .from('assignments')
                .delete()
                .neq('id', 0);

            if (deleteError) throw deleteError;

            const { error: insertError } = await supabaseClient
                .from('assignments')
                .insert(defaultAssignments);

            if (insertError) throw insertError;

            await loadData();
        } catch (error) {
            console.error('Error resetting data:', error);
            showError('Failed to reset data: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Render the table
    function renderTable() {
        const tableBody = document.getElementById('dataTableBody');
        const typeFilter = document.getElementById('tableTypeFilter').value;
        tableBody.innerHTML = '';

        const seColorMap = {
            "Rudra": "bg-indigo-50",
            "David": "bg-emerald-50",
            "Liam": "bg-amber-50"
        };

        const filteredAssignments = typeFilter === 'All' ? 
            assignments : 
            assignments.filter(a => a.type === typeFilter);

        filteredAssignments.forEach((assignment) => {
            const row = tableBody.insertRow();
            row.className = `whitespace-nowrap transition-colors duration-150 hover:bg-gray-100 ${seColorMap[assignment.se]}`;
            
            const typeBadgeColor = assignment.type === 'Bank' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';
            
            row.innerHTML = `
                <td class="px-6 py-4 text-sm">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeBadgeColor}">
                        ${assignment.type}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900">${assignment.opportunity_name}</td>
                <td class="px-6 py-4 text-sm">
                    <select 
                        onchange="updateAssignment(${assignment.id}, 'se', this.value)"
                        class="text-sm border-gray-300 rounded px-2 py-1 bg-white hover:border-indigo-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                    >
                        <option value="Rudra" ${assignment.se === 'Rudra' ? 'selected' : ''}>Rudra</option>
                        <option value="David" ${assignment.se === 'David' ? 'selected' : ''}>David</option>
                        <option value="Liam" ${assignment.se === 'Liam' ? 'selected' : ''}>Liam</option>
                    </select>
                </td>
                <td class="px-6 py-4 text-sm">
                    <select 
                        onchange="updateAssignment(${assignment.id}, 'stage', this.value)"
                        class="text-xs border-gray-300 rounded px-2 py-1 font-semibold hover:border-indigo-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                        style="background-color: ${stageColors[assignment.stage]}20; color: ${stageColors[assignment.stage]};"
                    >
                        <option value="Top of Funnel" style="background-color: ${stageColors['Top of Funnel']}20; color: ${stageColors['Top of Funnel']};">Top of Funnel</option>
                        <option value="Middle of Funnel" style="background-color: ${stageColors['Middle of Funnel']}20; color: ${stageColors['Middle of Funnel']};">Middle of Funnel</option>
                        <option value="Bottom of Funnel" style="background-color: ${stageColors['Bottom of Funnel']}20; color: ${stageColors['Bottom of Funnel']};">Bottom of Funnel</option>
                    </select>
                </td>
                <td class="px-6 py-4 text-sm font-medium">
                    <button class="delete-btn" onclick="deleteAssignment(${assignment.id})">Delete</button>
                </td>
            `;
        });
    }

    // Destroy chart if exists
    function destroyChart(chartId) {
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy();
            chartInstances[chartId] = null;
        }
    }

    // Create bar chart
    function createBarChart(canvasId, labels, data, title, colors) {
        destroyChart(canvasId);
        const ctx = document.getElementById(canvasId).getContext('2d');

        chartInstances[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: title,
                    data: data,
                    backgroundColor: colors || ['#4F46E5', '#10B981', '#F59E0B'],
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Count' },
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    }

    // Create doughnut chart
    function createDoughnutChart(canvasId, labels, data, title) {
        destroyChart(canvasId);
        const ctx = document.getElementById(canvasId).getContext('2d');
        const total = data.reduce((a, b) => a + b, 0);

        // Determine colors based on chart type
        let colors;
        if (canvasId === 'typeDistributionChart') {
            // Special colors for Banks vs ERPs
            colors = ['#3b82f6', '#8b5cf6']; // Blue for Banks, Purple for ERPs
        } else {
            // Use stage colors for funnel charts
            colors = labels.map(label => stageColors[label] || '#6b7280');
        }

        chartInstances[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: title,
                    data: data,
                    backgroundColor: colors,
                    hoverOffset: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    label += `${context.parsed} (${percentage}%)`;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Create grouped bar chart
    function createGroupedBarChart(canvasId, labels, datasets) {
        destroyChart(canvasId);
        const ctx = document.getElementById(canvasId).getContext('2d');

        chartInstances[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'top' } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    }

    // Refresh dashboard
    function refreshDashboard() {
        renderTable();

        if (currentView === 'banks') {
            updateBanksView();
        } else if (currentView === 'erps') {
            updateErpsView();
        } else if (currentView === 'combined') {
            updateCombinedView();
        }
    }

    function updateBanksView() {
        const banks = assignments.filter(a => a.type === 'Bank');
        const seFilter = document.getElementById('bankSeFilter').value;
        
        const filteredBanks = seFilter === 'All' ? banks : banks.filter(b => b.se === seFilter);
        
        // SE Capacity for Banks
        const bankSeCounts = seNames.map(se => banks.filter(b => b.se === se).length);
        createBarChart('bankCapacityChart', seNames, bankSeCounts, 'Banks', ['#4F46E5', '#10B981', '#F59E0B']);
        
        // Bank Funnel Distribution
        const bankStageCounts = funnelStages.map(stage => filteredBanks.filter(b => b.stage === stage).length);
        document.getElementById('bankFunnelTitle').textContent = 
            seFilter === 'All' ? 'Bank Funnel Distribution (All SEs)' : `Bank Funnel Distribution (${seFilter})`;
        createDoughnutChart('bankFunnelChart', funnelStages, bankStageCounts, 'Banks');
    }

    function updateErpsView() {
        const erps = assignments.filter(a => a.type === 'ERP');
        const seFilter = document.getElementById('erpSeFilter').value;
        
        const filteredErps = seFilter === 'All' ? erps : erps.filter(e => e.se === seFilter);
        
        // SE Capacity for ERPs
        const erpSeCounts = seNames.map(se => erps.filter(e => e.se === se).length);
        createBarChart('erpCapacityChart', seNames, erpSeCounts, 'ERPs', ['#4F46E5', '#10B981', '#F59E0B']);
        
        // ERP Funnel Distribution
        const erpStageCounts = funnelStages.map(stage => filteredErps.filter(e => e.stage === stage).length);
        document.getElementById('erpFunnelTitle').textContent = 
            seFilter === 'All' ? 'ERP Funnel Distribution (All SEs)' : `ERP Funnel Distribution (${seFilter})`;
        createDoughnutChart('erpFunnelChart', funnelStages, erpStageCounts, 'ERPs');
    }

    function updateCombinedView() {
        const banks = assignments.filter(a => a.type === 'Bank');
        const erps = assignments.filter(a => a.type === 'ERP');
        
        // Total SE Capacity
        const totalSeCounts = seNames.map(se => assignments.filter(a => a.se === se).length);
        createBarChart('totalCapacityChart', seNames, totalSeCounts, 'Total Assignments', ['#4F46E5', '#10B981', '#F59E0B']);
        
        // Banks vs ERPs Distribution
        createDoughnutChart('typeDistributionChart', ['Banks', 'ERPs'], [banks.length, erps.length], 'Type');
        
        // SE Assignments by Type
        const seTypeDatasets = [
            {
                label: 'Banks',
                data: seNames.map(se => banks.filter(b => b.se === se).length),
                backgroundColor: '#3b82f6',
            },
            {
                label: 'ERPs',
                data: seNames.map(se => erps.filter(e => e.se === se).length),
                backgroundColor: '#8b5cf6',
            }
        ];
        createGroupedBarChart('seTypeChart', seNames, seTypeDatasets);
        
        // Funnel Stage Comparison
        const stageDatasets = [
            {
                label: 'Banks',
                data: funnelStages.map(stage => banks.filter(b => b.stage === stage).length),
                backgroundColor: '#3b82f6',
            },
            {
                label: 'ERPs',
                data: funnelStages.map(stage => erps.filter(e => e.stage === stage).length),
                backgroundColor: '#8b5cf6',
            }
        ];
        createGroupedBarChart('stageCombinedChart', funnelStages, stageDatasets);
    }

    // Set up real-time subscription
    function setupRealtimeSubscription() {
        if (!isConfigured) return;

        supabaseClient
            .channel('assignments-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'assignments' },
                (payload) => {
                    console.log('Change received!', payload);
                    loadData();
                }
            )
            .subscribe();
    }

    // Initialize
    window.onload = function() {
        loadData();
        setupRealtimeSubscription();
    };
</script>

</body>
</html>
